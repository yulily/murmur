---
title: "PHPStan å§‹ã‚ã¦ã¿ãŸ"
description: "å§‹ã‚ãŸã‚“ã ã‚ˆ..."
pubDate: "Dec. 24 2023"
heroImage: "/murmur/blog/230323.jpg"
---

ãƒ–ãƒ­ã‚°æ›¸ã‹ãªã„ã¨ã¨æ¯åº¦ã‚µãƒœã‚Šå½“æ—¥ã«ãªã‚Šã¨ã¦ã‚‚ç„¦ã£ã¦ã„ã‚‹ãªã†ã§ã™

æœ€è¿‘è§¦ã‚Šå§‹ã‚ãŸ PHPStan ã«ã¤ã„ã¦å­¦ç¿’è¨˜éŒ²ã«ãªã‚Šã¾ã™

ä½•ã‚’ã¨ã¡ç‹‚ã£ãŸã®ã‹ laravel ã§ã‚„ã‚ŠãŸã„ãªãã£ã¦ãªã‚Š (phpstan ã ã‘ã§ã¾ãšè©¦ã›ã‚ˆ!)
docker ã§ laravel ç’°å¢ƒä½œã£ã¦ãã“ã« phpstan å…¥ã‚Œã¦ã€ã“ã®ã‚³ãƒ¼ãƒ‰æ¤œçŸ¥ã—ã¦ãã‚Œãªã„ã‹ãªã€œã£ã¦æ„Ÿã˜ã§è§¦ã‚Šå§‹ã‚ã¾ã—ãŸ

docker-compose ã§ nginx ã¨ php ã®ç’°å¢ƒã‚’ä½œã‚Šã€php ã®ç’°å¢ƒã«ã¦ composer ã§ laravel ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™

Laravel ã‚’ä½¿ã†å ´åˆ PHPStanãƒ©ãƒƒãƒ‘ãƒ¼ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ [larastan/larastan](https://github.com/larastan/larastan)ã‚’å…¥ã‚Œã¾ã—ãŸ


ãƒ¬ã‚¬ã‚·ãƒ¼ãªã‚³ãƒ¼ãƒ‰ã‚’ã¨ã‚Šã‚ãˆãšç½®ã (ã‚‚ã¯ã‚„ laravelã˜ã‚ƒãªãã¦ã„ã„)
```
<?php

namespace App\Libraries;

class Hoge
{
    function Hoge()
    {
        $rows = [
            1 => self::a(-1),
            2 => self::a(1),
            3 => $this->a(1),
        ];

        $head = $rows{1};

        while (list($key, $value) = each($rows)) {
            $result[$key] = $value;
        }
    }

    private function a(int $b): int 
    {
        return $b + 1;
    }
}

```
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆphpstan.neonï¼‰ã¯ä¸€æ—¦ä»¥ä¸‹ã§
```
parameters:
    paths:
        - app/Libraries
        - app/Http
        - tests/
    level: 0
```

å®Ÿè¡Œã™ã‚‹ã¨ each ã¯å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã§æ¤œçŸ¥ã§ãã¦ã„ã‚‹ãŒã€æ³¢æ‹¬å¼§é…åˆ—ã‚¢ã‚¯ã‚»ã‚¹ã‚„[E_DEPRECATED](https://www.php.net/manual/ja/migration70.deprecated.php) ãªã‚‚ã®ãŒæ¤œçŸ¥ã•ã‚Œã¦ã„ãªã„...
```
/var/www/html/src # ./vendor/bin/phpstan analyse --memory-limit=1G
Note: Using configuration file /var/www/html/src/phpstan.neon.
 17/17 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

 ------ ------------------------------------------------------- 
  Line   app/Libraries/Hoge.php                                 
 ------ ------------------------------------------------------- 
  17     Function each not found.                               
         ğŸ’¡ Learn more at                                       
            https://phpstan.org/user-guide/discovering-symbols  
 ------ ------------------------------------------------------- 
```

ç·´ç¿’ãŒã¦ã‚‰ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’èª¿ã¹ã¦ã¿ã‚‹ã‹ã¨æ€ã£ãŸã‚‰ã€çµæ§‹ã“ã‚ŒãŒé›£ã—ãã†ã ã£ãŸ

ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’ä½œã‚‹ã«ã¯ã€PHPStan\Rules\Rule ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‰ã—ã„

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã¯ getNodeType ã¨ processNode ã¨ã„ã† 2ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã¦ã€
getNodeTypeãƒ¡ã‚½ãƒƒãƒ‰ã¯ ASTï¼ˆæŠ½è±¡æ§‹æ–‡æœ¨ï¼‰ãƒãƒ¼ãƒ‰ã®ã‚¿ã‚¤ãƒ—ã‚’è¿”ã—ã€è§£æã™ã‚‹éš›ã«æŒ‡å®šã—ãŸãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã«é­é‡ã™ã‚‹åº¦ã€
processNodeãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã€ãã®éš›ã®ç¬¬ä¸€å¼•æ•°ã¯ ASTãƒãƒ¼ãƒ‰ãŒã€ç¬¬äºŒå¼•æ•°ã«ã¯ç¾åœ¨ã®ã‚¹ã‚³ãƒ¼ãƒ—ãŒå…¥ã‚‹ã‚‰ã—ã„

processNodeãƒ¡ã‚½ãƒƒãƒ‰ã«ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å ±å‘Šã™ã‚‹ã‚¨ãƒ©ãƒ¼ã‚’å®šç¾©ã™ã‚‹ã¨ã®ã“ã¨

ASTã‚ã‹ã‚‰ã‚“ã¨èª¿ã¹ãŸæ„Ÿã˜ PHPã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«åˆ©ç”¨ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚‰ã—ã„ (PHP7ã‹ã‚‰ã‚‰ã—ã„)
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã®æµã‚Œã‚’èª¿ã¹ã‚‹ã¨ã€ã€Œå­—å¥è§£æ (ãƒˆãƒ¼ã‚¯ãƒ³ã«åˆ†è§£)ã€â†’ã€Œæ§‹æ–‡è§£æ (AST ä½œæˆ)ã€â†’ ã€ŒOpcodeç”Ÿæˆ (ä¸­é–“ã‚³ãƒ¼ãƒ‰)ã€ã¨ã‚ã‚Š

å­—å¥è§£æã¯æ„å‘³ã‚’æŒã¤æœ€å°å˜ä½ã«åˆ†è§£ã™ã‚‹ã‚‰ã—ã„ã€[ã“ã‚Œ](https://php.net/manual/ja/tokens.php)ã‹ãª

ã“ã®è¾ºã‚Šã¯ã‚¹ãƒ©ã‚¤ãƒ‰ã®å›³ã‚’è¦‹ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™
- [PHPStanã§CustomRuleã‚’ä½œã‚‹ / Make PHPStan CustomRule](https://speakerdeck.com/nazonohito51/make-phpstan-customrule-d596e237-6692-4e6b-b83b-f5fac3618797)
- [PHP AST å¾¹åº•è§£èª¬](https://speakerdeck.com/do_aki/php-ast-che-di-jie-shuo)
- [PHPã®é–¢æ•°å®Ÿè¡Œã¨ãã®è¨ˆæ¸¬](https://speakerdeck.com/sji/phpnoguan-shu-shi-xing-tosonoji-ce)

æ›´ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ²¸ã‹ã›ã‚‹ãŸã‚[nikic/php-parser](https://github.com/nikic/PHP-Parser)ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (PHPStan ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹) ã‚’ä½¿ã„ã€æ¤œè¨¼ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã©ã†ãªã£ã¦ã‚‹ã‹ã‚’ã–ã£ãã‚Šè¦‹ã¦ã¿ãŸã‚Šã‚‚ã—ã¾ã—ãŸ
```
        $code = file_get_contents(__DIR__ . '/../../Libraries/Hoge.php');
        $parser = (new ParserFactory)->create(ParserFactory::PREFER_PHP7);
        $stmts = $parser->parse($code);
        echo "<pre>";
        echo print_r($stmts, true);
        echo "</pre>";
```

ã“ã‚Œã‚‰ã‚’å‰æã«[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://apiref.phpstan.org/1.10.x/index.html)è¦‹ã¤ã¤ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’ 2ã¤ä½œã£ã¦ã¿ã¾ã—ãŸ

1ã¤ç›®ã¯ __construct ãŒæœªå®šç¾©ãªã‚¯ãƒ©ã‚¹ã¨åŒã˜ãƒ¡ã‚½ãƒƒãƒ‰åã®æ¤œçŸ¥ã§ã™
```
<?php declare(strict_types=1);

namespace PHPStan\Rules;

use PhpParser\Node;
use PhpParser\Node\Stmt\ClassMethod;
use PHPStan\Analyser\Scope;
use PHPStan\Rules\Rule;

class SameNameMethodAsClassRule implements Rule
{
    public function getNodeType(): string
    {
        return ClassMethod::class;
    }

    /**
     * @param ClassMethod $node
     * @param Scope $scope
     * @return string[] errors
     */
    public function processNode(Node $node, Scope $scope): array
    {
        $methodName = $node->name->name;

        $classReflection = $scope->getClassReflection();
        $classShortName = end(explode('\\', $classReflection->getName()));

        if ($methodName === $classShortName) {
            if ($classReflection && !$classReflection->hasMethod('__construct')) {
                return ["Class $classShortName has a method with the same name '$methodName' and also has a __construct method."];
            }
        }
        return [];
    }
}
```

ã‚‚ã†ä¸€ã¤ã¯éé™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å‘¼ã³å‡ºã—ã¦ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®æ¤œçŸ¥ã§ã™
```
<?php declare(strict_types=1);

namespace PHPStan\Rules;

use PhpParser\Node;
use PhpParser\Node\Expr\StaticCall;
use PHPStan\Analyser\Scope;
use PHPStan\Rules\Rule;

class StaticCallToNonStaticMethodRule implements Rule
{
    public function getNodeType(): string
    {
        return StaticCall::class;
    }

    /**
     * @param ClassMethod $node
     * @param Scope $scope
     * @return string[] errors
     */
    public function processNode(Node $node, Scope $scope): array
    {
        $methodName = $node->name->name;

        $reflectionClass = $scope->getClassReflection();
        if (!$reflectionClass->hasMethod($methodName)) {
            return [];
        }

        $reflectionMethod = $reflectionClass->getMethod($methodName, $scope);
    
        if (!$reflectionMethod->isStatic()) {
            return ["Calling a non-static method as a static method. '{$methodName}'."];
        }

        return [];

    }
}
```

ã“ã‚Œã‚’ phpstan/Rules ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦é…ç½®ã—
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã—ã¾ã™

```
parameters:
    paths:
        - app/Libraries
        - app/Http
        - tests/
    level: 0
    customRulesetUsed: true # è¿½åŠ 
rules:
    - PHPStan\Rules\SameNameMethodAsClassRule # è¿½åŠ 
    - PHPStan\Rules\StaticCallToNonStaticMethodRule # è¿½åŠ 
```

å®Ÿè¡Œã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§æ¤œçŸ¥ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
```
/var/www/html/src # ./vendor/bin/phpstan analyse --memory-limit=1G
Note: Using configuration file /var/www/html/src/phpstan.neon.
 17/17 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

 ------ ------------------------------------------------------------------ 
  Line   app/Libraries/Hoge.php                                            
 ------ ------------------------------------------------------------------ 
  7      Class Hoge has a method with the same name 'Hoge' and also has a  
         __construct method.                                               
  10     Calling a non-static method as a static method. 'a'.              
  11     Calling a non-static method as a static method. 'a'.              
  17     Function each not found.                                          
         ğŸ’¡ Learn more at                                                  
            https://phpstan.org/user-guide/discovering-symbols             
 ------ ------------------------------------------------------------------ 
```
ä¸€å¿œãƒ«ãƒ¼ãƒ«ç½®ãå ´æ‰€ã¯ã€autoload ã•ã‚Œã‚‹å ´æ‰€ã§ãªã„ã¨ã„ã‘ãªã‹ã£ãŸã®ã§ã€dev ã®æ–¹ã«è¿½åŠ ã—ã¦ã¾ã™
```
    "autoload-dev": {
        "psr-4": {
            "Tests\\": "tests/",
            "PHPStan\\": "phpstan/"
        }
    },
```

ã¡ã‚‡ã£ã¨ã‚¤ãƒ–ã ã—ã”é£¯ã‚’ä½œã£ã¦ãã¾ã™
(ã‚ã¨ã§æ¸…æ›¸ã•ã›ã¦ã‡...)